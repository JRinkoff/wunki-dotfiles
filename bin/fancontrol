#!/bin/sh

disable_fan()
{
  echo "disable"
  sysctl dev.acpi_ibm.0.fan=0
}

enable_fan()
{
  echo "enable"
  sysctl dev.acpi_ibm.0.fan=1
}

try_disable_fan()
{
  if [ `sysctl -n dev.acpi_ibm.0.fan` = 1 ]; then
    disable_fan
  fi
}

try_enable_fan()
{
  if [ `sysctl -n dev.acpi_ibm.0.fan` = 0 ]; then
    enable_fan
  fi
}

if [ `id -u` != 0 ]; then
  echo "Error: Must be root"
  exit 1
fi

while [ true ]; do

  HIGHEST_TEMP=0

  # TODO: Get a list of temperatures
  TEMPERATURES=`sysctl -n dev.acpi_ibm.0.thermal`

  for TEMP in $TEMPERATURES; do
    if [ $TEMP -gt $HIGHEST_TEMP ]; then
      HIGHEST_TEMP=$TEMP
    fi
  done

  if [ $HIGHEST_TEMP -gt 55 ]; then
    try_enable_fan
  elif [ $HIGHEST_TEMP -lt 45 ]; then
    try_disable_fan
  fi

  sleep 5

done
